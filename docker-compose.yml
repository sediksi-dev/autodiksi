version: '3'
services:
  n8n:
    image: n8nio/n8n:latest
    restart: always
    ports:
      - ${N8N_PORT}:5678
    environment:
      - N8N_QUEUE_TYPE=redis
      - N8N_QUEUE_HOST=redis
      - N8N_QUEUE_PORT=6379
      - N8N_QUEUE_NAME=n8n
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_PAYLOAD_SIZE_MAX=32
      - WEBHOOK_URL=https://n8n.likrea.biz.id/
      - GENERIC_TIMEZONE=Asia/Jakarta
      - TZ=Asia/Jakarta

    networks:
      - apinetwork
    depends_on:
      - mysql
      - redis
    volumes:
      - n8n_data:/home/node/.n8n

  mysql:
    image: mysql:latest
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    networks:
      - apinetwork
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:latest
    networks:
      - apinetwork

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    restart: always
    ports:
      - ${PORT}:${PORT}
    environment:
      - PORT=${PORT}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - API_KEY_EMAIL=${API_KEY_EMAIL}
      - API_KEY_PASSWORD=${API_KEY_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_ORGANIZATION=${OPENAI_ORGANIZATION}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - BRAVE_SEARCH_API_KEY=${BRAVE_SEARCH_API_KEY}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2}
      - LANGCHAIN_ENDPOINT=${LANGCHAIN_ENDPOINT}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT}
    volumes:
      - ./api/modules/wp/temp:/api/modules/wp/temp
    networks:
      - apinetwork

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    restart: always
    ports:
      - ${STREAMLIT_PORT}:8501
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - AGC_API_URL=http://api:${PORT}
      - AGC_API_USERNAME=${API_KEY_EMAIL}
      - AGC_API_PASSWORD=${API_KEY_PASSWORD}
    networks:
      - apinetwork

volumes:
  n8n_data:
    driver: local
  mysql_data:
    driver: local

networks:
  apinetwork:
    driver: bridge
